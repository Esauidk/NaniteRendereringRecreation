name: Documentation

env:
  DEPLOY_BRANCH_POSTFIX: docs # Configure the destination branch postfix (code on "main" branch will be built and pushed into "main-POSTFIX" branch)

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  Doxygen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Running Doxygen
        uses: mattnotmitt/doxygen-action@1.9.5
        with:
          doxyfile-path: ./Doxyfile
          working-directory: .
          enable-latex: true
        # Synchronize & push BUILD directory to deployment branch
      - name: Configure Git informations
        run: |
          git config --global user.name $GITHUB_ACTOR
          git config --global user.email $GITHUB_ACTOR@users.noreply.github.com
      - name: Push Docs To Branch
        run: |
          GIT_BRANCH=$(git rev-parse --symbolic-full-name --abbrev-ref HEAD)
          DEPLOY_BRANCH=$GIT_BRANCH-$DEPLOY_BRANCH_POSTFIX
          GIT_COMMIT=$(git rev-parse --short HEAD)
          git status
          git stash
          echo "Checking out $DEPLOY_BRANCH"
          git checkout -b $DEPLOY_BRANCH
          (git pull --depth 1 origin $DEPLOY_BRANCH --rebase -X theirs --allow-unrelated-histories) || (echo "Deployment branch synced")
          git stash pop
          git status
          git add -A
          git commit -m "Automated build $GIT_COMMIT"
          git push origin $DEPLOY_BRANCH
